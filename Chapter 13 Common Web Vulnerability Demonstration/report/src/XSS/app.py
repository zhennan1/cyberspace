from flask import Flask, render_template, request, escape
import sqlite3
import html

# 连接数据库
def connect_db():
    db = sqlite3.connect('test.db')
    db.cursor().execute('CREATE TABLE IF NOT EXISTS comments '
                        '(id INTEGER PRIMARY KEY, '
                        'comment TEXT)')
    db.commit()
    return db

# 添加评论
def add_comment(comment):
    db = connect_db()
    db.cursor().execute('INSERT INTO comments (comment) '
                        'VALUES (?)', (comment,))
    db.commit()

# 得到评论
def get_comments(search_query=None):
    db = connect_db()
    results = []
    get_all_query = 'SELECT comment FROM comments'
    for (comment,) in db.cursor().execute(get_all_query).fetchall():
        if search_query is None or search_query in comment:
            results.append(comment)
    return results

# 启动flask
app = Flask(__name__)
app.secret_key = 'supersecretkey'
@app.route('/', methods=['GET', 'POST'])

# XSS攻击漏洞

# def index():
#     if request.method == 'POST':
#         add_comment(request.form['comment'])

#     search_query = request.args.get('q')

#     comments = get_comments(search_query)

#     return render_template('index.html',
#                            comments=comments,
#                            search_query=search_query)

# XSS攻击防御：转义字符

def index():
    if request.method == 'POST':
        # 对输入进行转义处理
        comment = html.escape(request.form['comment'])  
        add_comment(comment)

    # 对搜索查询进行转义处理
    search_query = request.args.get('q')
    if search_query is None:
        search_query = ""
    else:
        search_query = html.escape(search_query)

    comments = get_comments(search_query)

    return render_template('index.html',
                           comments=comments,
                           search_query=search_query)
